# Orchids å¤šè´¦å·ç®¡ç†ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

æœ¬é€šè¿‡éä¾µå…¥å¼çš„æ–¹å¼ï¼Œåˆ©ç”¨ Cookie å¿«ç…§åŠ«æŒæŠ€æœ¯ï¼Œä¸º Orchids åº”ç”¨ç¨‹åºå®ç°å¤šè´¦å·ä¸€é”®åˆ‡æ¢åŠŸèƒ½ã€‚

---

## 1. æ ¸å¿ƒåŸç†ï¼šCookie å¿«ç…§åŠ«æŒ (Session Hijacking & Replay)

Orchids ä½¿ç”¨ **Clerk** è¿›è¡Œèº«ä»½è®¤è¯ã€‚Clerk çš„æŒä¹…åŒ–ç™»å½•ä¾èµ–äºä¸€ç»„ç‰¹å®šçš„æµè§ˆå™¨ Cookieï¼ˆä¸»è¦åŒ…å« `__session`ã€`__client`ã€`__client_uat`ï¼‰ã€‚

- **ç°çŠ¶**ï¼šOrchids å¯åŠ¨æ—¶è¯»å– Electron Session ä¸­çš„ Cookiesã€‚å¦‚æœ Cookies æœ‰æ•ˆï¼Œåº”ç”¨è‡ªåŠ¨æ˜¾ç¤ºç™»å½•çŠ¶æ€ï¼›å¦åˆ™æ˜¾ç¤ºç™»å½•é¡µã€‚
- **ç­–ç•¥**ï¼šæˆ‘ä»¬å¯ä»¥å°†â€œç™»å½•çŠ¶æ€â€è§†ä¸ºä¸€ç»„ Cookies çš„**å¿«ç…§ (Snapshot)**ã€‚
  - **ä¿å­˜è´¦å·** = å¯¼å‡ºå½“å‰æ‰€æœ‰ Cookies å¹¶æŒä¹…åŒ–å­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶ã€‚
  - **åˆ‡æ¢è´¦å·** = æ¸…ç©ºå½“å‰ Sessionï¼Œå°†ç›®æ ‡è´¦å·çš„ Cookies å¿«ç…§æ³¨å…¥å› Electron Sessionï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚
- **ä¼˜åŠ¿**ï¼š
  - **é•¿ä¹…æœ‰æ•ˆ**ï¼šClerk çš„ Client Cookie ç”¨äºè®¾å¤‡è®¤è¯ï¼Œé…åˆ Session Cookie å¯å®ç° Token çš„è‡ªåŠ¨åˆ·æ–°ï¼Œé¿å…äº†ä»…ä¿å­˜ JWT Token å¯¼è‡´çš„ 1 å°æ—¶è¿‡æœŸé—®é¢˜ã€‚
  - **é›¶ä¾µå…¥**ï¼šä¸éœ€è¦ä¿®æ”¹ Orchids çš„æ ¸å¿ƒé‰´æƒä»£ç æˆ–é€†å‘å…¶å¤æ‚çš„ç™»å½•é€»è¾‘ï¼Œåªéœ€åœ¨åº”ç”¨å±‚é¢ä¸Šâ€œéª—â€è¿‡å®ƒã€‚

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•°æ®å­˜å‚¨å±‚ (`accounts.json`)

åœ¨ç”¨æˆ·çš„åº”ç”¨æ•°æ®ç›®å½•ï¼ˆå¦‚ `~/Library/Application Support/Orchids/`ï¼‰ä¸‹åˆ›å»ºä¸€ä¸ªåŠ å¯†æˆ–å—ä¿æŠ¤çš„ JSON æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨è´¦å·åº“ã€‚

### 2.2 ä¸»è¿›ç¨‹æ¨¡å— (Main Process)

åœ¨ `main/index.js` ä¸­æ³¨å…¥ä¸€ä¸ªæ–°çš„æ¨¡å— `AccountManager`ï¼Œè´Ÿè´£ï¼š

- **IPC ç›‘å¬**ï¼šå“åº”å‰ç«¯çš„åˆ‡æ¢ã€æ·»åŠ ã€åˆ é™¤è´¦å·è¯·æ±‚ã€‚
- **Cookie æ“ä½œ**ï¼šä½¿ç”¨ Electron çš„ `session.defaultSession.cookies` API è¿›è¡Œ get/set/removeã€‚
- **çŠ¶æ€ç›‘å¬**ï¼šåœ¨â€œæ·»åŠ è´¦å·â€æ¨¡å¼ä¸‹ï¼Œç›‘å¬ Cookie å˜åŒ–ä»¥è‡ªåŠ¨æ•è·æ–°ç™»å½•çš„å‡­è¯ã€‚

### 2.3 æ¸²æŸ“è¿›ç¨‹æ¨¡å— (Renderer UI)

åœ¨å‰ç«¯ç•Œé¢ï¼ˆå¦‚å·¦ä¸‹è§’ç”¨æˆ·å¤´åƒå¤„æˆ–è®¾ç½®èœå•ï¼‰æ³¨å…¥ UI ç»„ä»¶ï¼š

- **è´¦å·åˆ—è¡¨**ï¼šæ˜¾ç¤ºå·²ä¿å­˜çš„è´¦å·å¤´åƒå’Œåç§°ã€‚
- **æ“ä½œæŒ‰é’®**ï¼šæ·»åŠ è´¦å·ã€é€€å‡ºç™»å½•ã€‚
- **çŠ¶æ€åé¦ˆ**ï¼šåˆ‡æ¢è¿‡ç¨‹ä¸­çš„ Loading çŠ¶æ€ã€‚

---

## 3. è¯¦ç»†å·¥ä½œæµç¨‹

### 3.1 ğŸ“¥ æµç¨‹ Aï¼šæ·»åŠ æ–°è´¦å· (Capture Flow)

1.  **ç”¨æˆ·è§¦å‘**ï¼šç‚¹å‡» UI ä¸Šçš„â€œæ·»åŠ æ–°è´¦å·â€æŒ‰é’®ã€‚
2.  **å‡†å¤‡ç¯å¢ƒ**ï¼š
    - åç«¯æ”¶åˆ° `PC_ADD_ACCOUNT` è¯·æ±‚ã€‚
    - **æ¸…ç†ç°åœº**ï¼šè°ƒç”¨ `session.clearStorageData()` æ¸…é™¤å½“å‰æ‰€æœ‰ Cookiesã€‚
    - **è¿›å…¥æ•è·æ¨¡å¼**ï¼šè®¾ç½®æ ‡å¿—ä½ `isCapturing = true`ï¼Œå¼€å§‹ç›‘å¬ `cookies.on('changed')`ã€‚
3.  **ç”¨æˆ·ç™»å½•**ï¼šOrchids æ­¤æ—¶ä¼šæ£€æµ‹åˆ°æ—  Cookieï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µã€‚ç”¨æˆ·åœ¨æµè§ˆå™¨/åº”ç”¨å†…å®Œæˆæ­£å¸¸çš„ç™»å½•æµç¨‹ã€‚
4.  **è‡ªåŠ¨æ•è·ä¸æ•°æ®è·å–**ï¼š

    - **A. æ•è· Cookies**ï¼š

      - ç›‘å¬å™¨æ£€æµ‹åˆ°å…³é”® Cookie `__session` è¢«å†™å…¥ã€‚
      - é˜²æŠ–åŠ¨ç­‰å¾…ï¼ˆDebounce 3 ç§’ï¼‰ï¼Œç¡®ä¿æ‰€æœ‰å…³è” Cookiesï¼ˆå¦‚ `__client`, `__client_uat`ï¼‰éƒ½å†™å…¥å®Œæ¯•ã€‚
      - è°ƒç”¨ `session.defaultSession.cookies.get({})` è·å–å½“å‰æ‰€æœ‰ Cookies çš„å¿«ç…§ã€‚

    - **B. æå– Session Token**ï¼š

      - ä» Cookies ä¸­æ‰¾åˆ°åç§°ä¸º `__session` çš„ Cookieã€‚
      - å…¶å€¼å³ä¸º JWT Tokenï¼ˆç”¨äºåç»­ API è°ƒç”¨ï¼‰ã€‚

    - **C. è·å–ç”¨æˆ·åŠé¢åº¦ä¿¡æ¯**ï¼ˆä½¿ç”¨ Node.js `fetch`ï¼‰ï¼š

      - **è§£æ Token**ï¼šå…ˆè§£æ JWT Token çš„ Payload (Base64 è§£ç ä¸­é—´éƒ¨åˆ†)ï¼Œè·å– `sub` å­—æ®µï¼ˆå³ `userId`ï¼‰ã€‚
      - **è°ƒç”¨ API**ï¼š
        ```javascript
        const userId = decodedToken.sub; // ä¾‹å¦‚ "user_2qX..."
        const response = await fetch(
          `https://orchids-server.calmstone-6964e08a.westeurope.azurecontainerapps.io/user/profile/${userId}`,
          {
            method: "GET",
            headers: {
              Authorization: `Bearer ${sessionToken}`,
              "Content-Type": "application/json",
            },
          }
        );
        const profileData = await response.json();
        // è¿”å›æ•°æ®ç¤ºä¾‹:
        // {
        //   "id": 12345,
        //   "userId": "user_2qX...",
        //   "fullName": "Huaan",
        //   "email": "huaan@example.com",
        //   "imageUrl": "https://img.clerk.com/...",
        //   "credits": 42000,
        //   "plan": "FREE"
        // }
        ```

    - **D. æŒä¹…åŒ–å­˜å‚¨**ï¼š
      - å°† `{ userId, userInfo: profileData, cookies }` ç»„åˆï¼Œå†™å…¥ `accounts.json`ã€‚

5.  **ç»“æŸæ•è·**ï¼šé€šè¿‡ IPC é€šçŸ¥å‰ç«¯â€œæ·»åŠ æˆåŠŸâ€ï¼Œå‰ç«¯æ›´æ–°åˆ—è¡¨ã€‚

### 3.2 ğŸ”„ æµç¨‹ Bï¼šåˆ‡æ¢è´¦å· (Switch Flow)

1.  **ç”¨æˆ·è§¦å‘**ï¼šåœ¨åˆ—è¡¨ä¸­ç‚¹å‡»ç›®æ ‡è´¦å·ï¼ˆä¾‹å¦‚ User Bï¼‰ã€‚
2.  **åç«¯æ‰§è¡Œ**ï¼š
    - **æ¸…ç†**ï¼š`session.clearStorageData()` æ¸…ç©ºå½“å‰ä¼šè¯ã€‚
    - **è¯»å–**ï¼šä» `accounts.json` è¯»å– User B çš„ Cookies å¿«ç…§ã€‚
    - **æ³¨å…¥**ï¼šéå† Cookies æ•°ç»„ï¼Œä½¿ç”¨ `session.cookies.set(cookie)` é€ä¸ªæ¢å¤ã€‚æ³¨æ„éœ€è¦æ¢å¤å…³é”®å±æ€§ï¼ˆå¦‚ `domain`, `path`, `secure`, `sameSite`ï¼‰ã€‚
3.  **åˆ·æ–°åº”ç”¨**ï¼š
    - è°ƒç”¨ `mainWindow.reload()`ã€‚
4.  **å®Œæˆ**ï¼šOrchids é‡å¯åè¯»å–åˆ° Session ä¸­å·²å­˜åœ¨ User B çš„ Cookiesï¼Œè‡ªåŠ¨åˆå§‹åŒ–ä¸º User B çš„ç™»å½•æ€ã€‚

---

## 4. æ•°æ®ç»“æ„è®¾è®¡

**æ–‡ä»¶ä½ç½®**: `~/Library/Application Support/Orchids/multi_accounts.json`

```json
{
  "version": "1.0",
  "activeUserId": "user_2qX...",
  "accounts": [
    {
      "id": "user_2qX...",            // Clerk User ID
      "displayName": "Huaan",         // æ˜¾ç¤ºåç§°
      "email": "huaan@example.com",   // é‚®ç®±
      "avatarUrl": "https://img...",  // å¤´åƒé“¾æ¥
      "lastActiveAt": 1704200000000,  // æœ€åæ´»è·ƒæ—¶é—´
      "cookies": [                    // Cookie å¿«ç…§
        {
          "name": "__session",
          "value": "...",
          "domain": ".orchids.app",
          "path": "/",
          "secure": true,
          "httpOnly": false,
          "expirationDate": 1704300000
        },
        {
          "name": "__client",
          "value": "...",
          "domain": ".orchids.app",
          ...
        }
        // ... å…¶ä»–å¿…è¦ Cookies
      ]
    }
  ]
}
```

---

## 5. å¯è¡Œæ€§éªŒè¯ (POC) æ­¥éª¤

åœ¨æ­£å¼å¼€å‘å‰ï¼Œæˆ‘ä»¬å…ˆè¿›è¡Œä¸€æ¬¡æ‰‹åŠ¨éªŒè¯ï¼š

1.  **æ‰‹åŠ¨æå–**ï¼šåœ¨å½“å‰ Orchids è°ƒè¯•æ§åˆ¶å°è¿è¡Œ `session.defaultSession.cookies.get({})`ï¼Œå°†ç»“æœä¿å­˜ä¸º `cookies_a.json`ã€‚
2.  **æ‰‹åŠ¨ç™»å‡º**ï¼šè¿è¡Œ `session.defaultSession.clearStorageData()`ï¼Œç¡®è®¤åº”ç”¨é€€å›åˆ°ç™»å½•é¡µã€‚
3.  **ç™»å½•æ–°å·**ï¼šç™»å½•è´¦å· Bï¼ŒåŒæ ·æå– Cookies ä¿å­˜ä¸º `cookies_b.json`ã€‚
4.  **æµ‹è¯•è¿˜åŸ**ï¼š
    - å†æ¬¡æ¸…ç©ºæ•°æ®ã€‚
    - ç¼–å†™ä¸€æ®µè„šæœ¬ï¼Œè¯»å– `cookies_a.json` å¹¶åœ¨æ§åˆ¶å°å¾ªç¯æ‰§è¡Œ `cookies.set()`ã€‚
    - æ‰§è¡Œ `location.reload()`ã€‚
    - **é¢„æœŸç»“æœ**ï¼šåº”ç”¨æ— éœ€å†æ¬¡ç™»å½•ï¼Œç›´æ¥å˜å›äº†è´¦å· A çš„çŠ¶æ€ã€‚

---

## 6. æŠ€æœ¯éš¾ç‚¹ä¸åº”å¯¹

| éš¾ç‚¹                     | è§£å†³æ–¹æ¡ˆ                                                                                                                                                         |
| :----------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **HttpOnly Cookie è¯»å–** | Electron ä¸»è¿›ç¨‹æ‹¥æœ‰æœ€é«˜æƒé™ï¼Œå¯ä»¥æ— è§† HttpOnly æ ‡å¿—è¯»å–å’Œå†™å…¥æ‰€æœ‰ Cookiesã€‚                                                                                      |
| **Cookie æœ‰æ•ˆæœŸ**        | Clerk çš„ `__client` Cookie æœ‰æ•ˆæœŸæé•¿ï¼ˆé€šå¸¸ä¸ºä¸€å¹´ï¼‰ï¼Œåªè¦æ­¤ Cookie å­˜åœ¨ï¼ŒClerk å°±ä¼šå°è¯•é™é»˜åˆ·æ–° Session Tokenã€‚æˆ‘ä»¬çš„å¿«ç…§åŒ…å«æ­¤ Cookieï¼Œç†è®ºä¸Šå¯å®ç°â€œæ°¸ä¹…â€ç™»å½•ã€‚ |
| **å¹¶å‘å†™å…¥å†²çª**         | åˆ‡æ¢è´¦å·æ—¶ï¼Œå¿…éœ€ç¡®ä¿ `clearStorageData` å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼ˆå®ƒæ˜¯ Promiseï¼‰åå†è¿›è¡Œ `cookies.set`ï¼Œå¦åˆ™ä¼šå¯¼è‡´çŠ¶æ€æ··åˆã€‚                                                 |
| **è·¨åŸŸé—®é¢˜**             | è®¾ç½® Cookie æ—¶å¿…é¡»ä¸¥æ ¼åŒ¹é…åŸæœ‰çš„ `domain`ï¼ˆå¦‚ `.orchids.app` æˆ– `.clerk.orchids.app`ï¼‰ï¼Œå¦åˆ™ä¼šè¢«æµè§ˆå™¨å®‰å…¨ç­–ç•¥æ‹’ç»ã€‚                                             |

---

## 7. å¼€å‘è®¡åˆ’

1.  **Phase 1: åŸºç¡€è®¾æ–½ (Backend)**

    - åˆ›å»º `AccountManager` ç±»ã€‚
    - åœ¨ä¸»è¿›ç¨‹ `index.js` ä¸­æŒ‚è½½ IPC æ¥å£ã€‚
    - å®ç° `loadAccounts` å’Œ `saveAccount` æ–‡ä»¶è¯»å†™é€»è¾‘ã€‚

2.  **Phase 2: æ ¸å¿ƒé€»è¾‘ (Logic)**

    - å®ç° `captureSession`ï¼šCookie ç›‘å¬ä¸ API æ•°æ®è·å–ã€‚
    - å®ç° `restoreSession`ï¼šCookie æ¸…ç†ä¸æ³¨å…¥ã€‚

3.  **Phase 3: ç”¨æˆ·ç•Œé¢ (Frontend)**

    - åœ¨ä¾§è¾¹æ åº•éƒ¨æ³¨å…¥ React ç»„ä»¶ã€‚
    - å®ç°ç®€å•çš„è´¦å·åˆ—è¡¨å¼¹çª—ã€‚

4.  **Phase 4: é›†æˆæµ‹è¯•**
    - æµ‹è¯•è´¦å·åˆ‡æ¢çš„æµç•…åº¦ã€‚
    - æµ‹è¯•åº”ç”¨é‡å¯åçš„çŠ¶æ€ä¿æŒã€‚
